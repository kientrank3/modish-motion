<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <div th:replace="components/head :: head"></div>
    <title>Hồ Sơ Của Tôi</title>
</head>
<body class="bg-gray-100" data-theme="light">
<header th:replace="components/header"></header>
<div class="container mx-auto my-4 md:my-10 pt-16 md:pt-20 px-4 md:px-0" >
    <div class="flex flex-col md:flex-row md:space-x-4">
        <div class="w-full md:w-1/6 bg-gray-100 p-4 mb-4 md:mb-0 rounded-lg">
            <div class="flex items-center space-x-4 mb-6">
                <img th:src="@{/images/profile/hamburmeo.jfif}" alt="avatar" class="rounded-full w-12 h-12 md:w-14 md:h-14 object-cover">
                <div class="flex-1 min-w-0">
                    <div>
                        <p class="text-sm md:text-base" th:text="'Welcome, ' + ${user.username}"></p>
                        <p id="customerId" class="hidden" th:text="${user.user.id}"></p>
                    </div>
                    <p class="text-gray-800 font-bold"></p>
                    <a href="#" class="text-blue-500 text-xs md:text-sm hover:underline">Sửa Hồ Sơ</a>
                </div>
            </div>
            <ul class="text-base md:text-lg text-gray-600 gap-2">
                <li class="py-2">
                    <a href="#" th:onclick="|window.location.href='@{/profile?tab=profile}'|" class="flex items-center" th:classappend="${selectedTab == 'profile'} ? 'text-red-500' : ''">Hồ Sơ</a>
                </li>
                <li class="py-2">
                    <a href="#" th:onclick="|window.location.href='@{/profile?tab=address}'|" class="flex items-center" th:classappend="${selectedTab == 'address'} ? 'text-red-500' : ''">Địa Chỉ</a>
                </li>
                <li class="py-2">
                    <a href="#" th:onclick="|window.location.href='@{/profile?tab=password}'|" class="flex items-center" th:classappend="${selectedTab == 'password'} ? 'text-red-500' : ''">Đổi Mật Khẩu</a>
                </li>
                <li class="py-2">
                    <a href="#" th:onclick="|window.location.href='@{/profile?tab=orders}'|" class="flex items-center" th:classappend="${selectedTab == 'orders'} ? 'text-red-500' : ''">Đơn Mua</a>
                </li>
            </ul>
        </div>

        <!-- Profile Content -->
        <div class=" w-full md:w-5/6 p-4 md:p-6">
            <div th:if="${selectedTab == 'profile'}">
                <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-2">Hồ Sơ Của Tôi</h2>
                <p class="text-sm md:text-base text-gray-500 mb-6">Quản lý thông tin hồ sơ để bảo mật tài khoản</p>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Profile Form -->
                    <div class="col-span-1 md:col-span-2 space-y-4">
                        <form class="space-y-4">
                            <div class="mb-4 space-y-2">
                                <label for="username" class="block text-sm font-semi bold text-gray-600">Tên đăng nhập</label>
                                <p id="username" class="text-gray-800" th:text="${user.username}"></p>
                            </div>
                            <div class="mb-4 space-y-2">
                                <label for="name" class="block text-sm font-semi bold text-gray-600">Tên</label>
                                <p  id="name" class="text-gray-800" th:text="${user.user.name}"></p>
                            </div>
                            <div class="mb-4 space-y-2">
                                <label for="email" class="block text-sm font-semi bold text-gray-600">Email</label>
                                <p id="email" class="text-gray-800" th:text="${user.user.email}"> <a href="#" class="text-blue-500 text-sm hover:underline">Thay Đổi</a></p>
                            </div>
                            <div class="mb-4 space-y-2">
                                <label for="phone" class="block text-sm font-semi bold text-gray-600">Số điện thoại</label>
                                <p id="phone" class="text-gray-800" th:text="${user.user.phoneNumber}"> <a href="#" class="text-blue-500 text-sm hover:underline">Thay Đổi</a></p>
                            </div>
                            <div class="mb-4 space-y-2">
                                <label class="block text-sm font-semi bold text-gray-600">Giới tính</label>
                                <div class="flex items-center space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="gender" class="form-radio text-blue-500"
                                               th:checked="${user.user.gender == false}">
                                        <span class="ml-2">Nam</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="gender" class="form-radio text-blue-500"
                                               th:checked="${user.user.gender == true}">
                                        <span class="ml-2">Nữ</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="dob" class="block text-sm font-semi bold text-gray-600">Ngày sinh</label>
                                <p id="dob" class="text-gray-800" th:text="${user.user.getDob()}"> <a href="#" class="text-blue-500 text-sm hover:underline">Thay Đổi</a></p>
                            </div>
                            <button type="submit" class="btn btn-warning text-white px-4 py-2 rounded-lg">Lưu</button>
                        </form>
                    </div>

                    <!-- Profile Picture -->
                    <div class="flex flex-col items-center space-y-4">
                        <img th:src="@{/images/profile/hamburmeo.jfif}" alt="avatar" class="rounded-full w-32 h-32 mb-4 object-cover">
                        <button class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">Chọn Ảnh</button>
                        <p class="text-gray-500 text-xs mt-4">Dung lượng file tối đa 1 MB</p>
                        <p class="text-gray-500 text-xs">Định dạng: .JPEG, .PNG</p>
                    </div>
                </div>
                </div>
            </div>

            <!-- Địa Chỉ -->
            <div th:if="${selectedTab == 'address'}">
                <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-4 md:p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 md:mb-6">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-2 md:mb-0">Địa Chỉ</h2>
                        <button class="w-full md:w-auto btn text-white px-4 py-2 rounded btn-warning" onclick="showUpdateAddressForm()">
                            Thay đổi địa chỉ
                        </button>
                    </div>
                    <div class="max-w-4xl mx-auto bg-white border-t border-gray-300 p-6">
                        <!-- Tiêu đề -->
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-xl font-bold">Địa chỉ của tôi</h1>

                        </div>
                        <!-- Danh sách địa chỉ -->
                        <div class="address-list space-y-6" id="addressList">
                            <!-- Địa chỉ -->
                            <div class="address-item border-b pb-4">
                                <div class="text-lg font-bold" th:text="${user.user.name}"></div>
                                <div class="text-gray-600" th:text="${user.user.address}"></div>
                                <div class="text-gray-500" th:text="${user.user.phoneNumber}"></div>
                            </div>
                        </div>
                        <div id="updateAddressForm" class="hidden">
                            <form class="w-full" th:action="@{/profile/change-address}" method="post">
                                <div class="mb-4 flex items-center">
                                    <label for="newName" class="w-1/4 text-gray-600 text-right mr-4">Họ và tên</label>
                                    <input type="text" class="input input-bordered w-2/4" id="newName" name="newName"
                                           placeholder="Nhập họ và tên mới (nếu cần)" th:value="${user.user.name}">
                                </div>
                                <div class="mb-4 flex items-center">
                                    <label for="newAddress" class="w-1/4 text-gray-600 text-right mr-4">Địa chỉ mới</label>
                                    <input type="text" class="input input-bordered w-2/4" id="newAddress" name="newAddress"
                                           placeholder="Nhập địa chỉ mới" th:value="${user.user.address}" required>
                                </div>
                                <div class="mb-4 flex items-center">
                                    <label for="newPhoneNumber" class="w-1/4 text-gray-600 text-right mr-4">Số điện thoại</label>
                                    <input type="text" class="input input-bordered w-2/4" id="newPhoneNumber" name="newPhoneNumber"
                                           placeholder="Nhập số điện thoại mới" th:value="${user.user.phoneNumber}" required>
                                </div>

                                <!-- Nút Lưu -->
                                <div class="flex justify-center mt-6">
                                    <button type="submit" class="btn btn-warning text-white px-8 py-2 rounded-lg w-1/3 text-center">
                                        Lưu thay đổi
                                    </button>
                                    <button type="button" onclick="cancelUpdateAddress()" class="bg-gray-300 text-black px-8 py-2 rounded-lg hover:bg-gray-400 w-1/3 text-center ml-4">
                                        Hủy
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Đổi Mật Khẩu -->
            <div th:if="${selectedTab == 'password'}">
                <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Đổi Mật Khẩu</h2>
                <p class="text-gray-500 mb-6">Để bảo mật tài khoản, vui lòng không chia sẻ mật khẩu cho người khác</p>

                <form class="w-full" th:action="@{/profile/change-password}" method="post">
                    <div class="mb-4 flex items-center">
                        <label for="oldPassword" class="w-1/4 text-gray-600 text-right mr-4"> Mật khẩu cũ</label>
                        <div class="flex items-center gap-2 input input-bordered w-2/4">
                            <input type="password" class="grow w-full" id="oldPassword" name="oldPassword"/>
                            <i id="toggleOldPassword" data-lucide="eye-closed" class="w-4 h-4 cursor-pointer"
                               onclick="togglePasswordVisibility('oldPassword', 'toggleOldPassword')"></i>
                        </div>
                    </div>

                    <div class="mb-4 flex items-center">
                        <label for="newPassword" class="w-1/4 text-gray-600 text-right mr-4">Mật khẩu mới</label>
                        <div class="flex items-center gap-2 input input-bordered w-2/4">
                            <input type="password" class="grow w-full" id="newPassword" name="newPassword"/>
                            <i id="toggleNewPassword" data-lucide="eye-closed" class="w-4 h-4 cursor-pointer"
                               onclick="togglePasswordVisibility('newPassword', 'toggleNewPassword')"></i>
                        </div>
                    </div>

                    <div class="mb-4 flex items-center">
                        <label for="confirmPassword" class="w-1/4 text-gray-600 text-right mr-4">Nhập lại mật khẩu mới</label>
                        <div class="flex items-center gap-2 input input-bordered w-2/4">
                            <input type="password" class="grow w-full" id="confirmPassword" oninput="checkPasswordMatch()"/>
                            <i id="toggleConfirmPassword" data-lucide="eye-closed" class="w-4 h-4 cursor-pointer"
                               onclick="togglePasswordVisibility('confirmPassword', 'toggleConfirmPassword')"></i>
                        </div>
                    </div>
                    <p id="passwordMismatchError" class="hidden text-red-500 text-sm text-center">
                        Mật khẩu mới và xác nhận mật khẩu không khớp.
                    </p>

                    <!-- Nút Lưu ở giữa -->
                    <div class="flex justify-center mt-6">
                        <button type="submit" class="btn text-white px-8 py-2 rounded-lg w-1/3 text-center btn-warning">Đổi mật khẩu</button>
                    </div>
                    <div th:if="${param.error == 'oldPassword'}" class="mt-4 text-red-500 text-center">
                        Mật khẩu cũ không chính xác.
                    </div>
                    <div th:if="${param.error == 'confirmMismatch'}" class="mt-4 text-red-500 text-center">
                        Mật khẩu mới và nhập lại mật khẩu không khớp.
                    </div>
                    <div th:if="${param.error == 'invalidNewPassword'}" class="mt-4 text-red-500 text-center">
                        Mật khẩu mới không hợp lệ! Phải bắt đầu bằng chữ hoa, có số và ký tự đặc biệt, độ dài tối thiểu 8 ký tự.
                    </div>
                    <div th:if="${param.success != null}" class="mt-4 text-green-500 text-center">
                        Đổi mật khẩu thành công!
                    </div>
                </form>

                </div>
            </div>


            <!-- Đơn Mua -->
            <div th:if="${selectedTab == 'orders'}">
                <div id="orderListContain" class="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-4 md:p-6">
                        <!-- Tabs -->
                        <nav class="tabs flex flex-wrap gap-2 md:gap-4 border-b overflow-x-auto">
                            <button class="tab-item whitespace-nowrap px-3 md:px-4 py-2 text-sm md:text-base text-gray-500 border-b-2 border-transparent hover:text-blue-500 hover:border-blue-500 focus:outline-none"
                                    onclick="filterOrders('all')">
                                Tất cả
                            </button>
                            <button class="tab-item whitespace-nowrap px-3 md:px-4 py-2 text-sm md:text-base text-gray-500 border-b-2 border-transparent hover:text-blue-500 hover:border-blue-500 focus:outline-none"
                                    onclick="filterOrders('pending')">
                                Chờ thanh toán
                            </button>
                            <button class="tab-item whitespace-nowrap px-3 md:px-4 py-2 text-sm md:text-base text-gray-500 border-b-2 border-transparent hover:text-blue-500 hover:border-blue-500 focus:outline-none"
                                    onclick="filterOrders('shipping')">
                                Vận chuyển
                            </button>
                            <button class="tab-item whitespace-nowrap px-3 md:px-4 py-2 text-sm md:text-base text-gray-500 border-b-2 border-transparent hover:text-blue-500 hover:border-blue-500 focus:outline-none"
                                    onclick="filterOrders('delivered')">
                                Chờ giao hàng
                            </button>
                            <button class="tab-item whitespace-nowrap px-3 md:px-4 py-2 text-sm md:text-base text-gray-500 border-b-2 border-transparent hover:text-blue-500 hover:border-blue-500 focus:outline-none"
                                    onclick="filterOrders('completed')">
                                Hoàn thành
                            </button>
                            <button class="tab-item whitespace-nowrap px-3 md:px-4 py-2 text-sm md:text-base text-gray-500 border-b-2 border-transparent hover:text-blue-500 hover:border-blue-500 focus:outline-none"
                                    onclick="filterOrders('cancelled')">
                                Đã hủy
                            </button>
                        </nav>
                        <!-- Danh sách đơn hàng -->
                        <div id="orderList" class="mt-4 space-y-4">
                            <p class="text-center text-gray-500">Đang tải đơn hàng...</p>
                        </div>
                    </div>
                <div id="orderDetails" class="hidden max-w-6xl mx-auto bg-white rounded-lg shadow-md p-6">
                    <!-- Nội dung chi tiết đơn hàng sẽ được script render -->

                    <div id="orderDetailsContent">
                        <!-- Nội dung chi tiết đơn hàng -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:replace="/components/lucide_icons :: lucide_icon"></div>
<footer th:replace="components/footer"></footer>

<script>
    function showUpdateAddressForm() {
        // Ẩn danh sách địa chỉ
        document.getElementById('addressList').classList.add('hidden');

        // Hiển thị form cập nhật địa chỉ
        document.getElementById('updateAddressForm').classList.remove('hidden');
    }

    function cancelUpdateAddress() {
        // Hiển thị danh sách địa chỉ
        document.getElementById('addressList').classList.remove('hidden');

        // Ẩn form cập nhật địa chỉ
        document.getElementById('updateAddressForm').classList.add('hidden');
    }
    function togglePasswordVisibility(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        if (input.type === "password") {
            input.type = "text";
            icon.setAttribute("data-lucide", "eye");
        } else {
            input.type = "password";
            icon.setAttribute("data-lucide", "eye-closed");
        }
        lucide.createIcons();  // Để cập nhật biểu tượng sau khi thay đổi thuộc tính
    }
    function checkPasswordMatch() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const error = document.getElementById('passwordMismatchError');

        if (newPassword !== confirmPassword) {
            error.classList.remove('hidden');
        } else {
            error.classList.add('hidden');
        }
    }
    const customerId = document.getElementById('customerId').textContent;
    function fetchOrders(status = 'all') {
        const orderList = document.getElementById('orderList');
        orderList.innerHTML = '<p class="text-center text-gray-500">Đang tải...</p>';

        let url = `/api/orders/${customerId}`;
        if (status !== 'all') url += `?status=${status}`;

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Không thể tải dữ liệu');
                return response.json();
            })
            .then(data => {
                if (data.length === 0) {
                    orderList.innerHTML = '<p class="text-center text-gray-500">Không có đơn hàng nào.</p>';
                    return;
                }
                data.sort((a, b) => new Date(b.orderAt) - new Date(a.orderAt));

                orderList.innerHTML = data.map(order => `
                <div class="order-item border rounded-lg p-4">
                    <div class="flex justify-between items-center">
                        <div>Mã đơn hàng: ${order.id}</div>
                        <div>
                            <button class="bg-gray-100 px-4 py-2 rounded mr-2">Chat</button>
                            <button class="bg-gray-100 px-4 py-2 rounded">Xem Shop</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        ${order.orderDetails.map(detail => `
                            <div class="flex items-center mb-4" >
                                <img src="${detail.variant.imageUrls[0] || 'https://via.placeholder.com/100'}"
                                     alt="Product Image" class="w-20 h-20 object-cover rounded mr-4"/>
                                <div>
                                    <a onclick="fetchOrderDetails(${order.id})" class="cursor-pointer"><h3 class="font-bold">${detail.variant.name}</h3></a>
                                    <p>Số lượng: ${detail.quantity}</p>
                                    <p>Giá: ${detail.variant.price.toLocaleString()}đ</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="text-green-500 font-bold">${getStatusText(order.status)}</div>
                        <div class="text-right">
                            <p class="text-gray-500">Tổng cộng:</p>
                            <p class="text-red-500 font-bold">${order.totalDue.toLocaleString()}đ</p>
                        </div>
                    </div>
                </div>
            `).join('');
            })
            .catch(error => {
                console.error(error);
                orderList.innerHTML = '<p class="text-center text-red-500">Đã xảy ra lỗi khi tải dữ liệu.</p>';
            });
    }
    function fetchOrderDetails(orderId) {
        console.log("Fetching order details for ID:", orderId);
        if (!orderId) {
            console.error("Order ID không hợp lệ:", orderId);
            return;
        }
        const orderList = document.getElementById('orderListContain');
        const orderDetails = document.getElementById('orderDetails');
        orderDetails.innerHTML = '<p class="text-center text-gray-500">Đang tải chi tiết đơn hàng...</p>';

        // Hiển thị chi tiết đơn hàng và ẩn danh sách
        orderList.classList.add('hidden');
        orderDetails.classList.remove('hidden');

        const url = `/api/orders/details/${orderId}`;
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Không thể tải chi tiết đơn hàng');
                return response.json();
            })
            .then(order => {
                orderDetails.innerHTML = `
                <button onclick="showOrderList()" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">
                        Quay lại
                </button>
                <div class="order-details bg-white shadow rounded-lg p-6 mt-6">
                    <p class="font-semibold">Mã đơn hàng: <span>${order.id}</span></p>
                    <p class="font-semibold">Ngày đặt hàng: <span>${formatDate(order.orderAt)}</span></p>
                    <p class="font-semibold">Tổng tiền: <span>${formatCurrency(order.totalDue)}</span></p>
                    <p class="font-semibold">Trạng thái: <span>${getStatusText(order.status)}</span></p>

                    <h3 class="text-lg font-bold mt-6">Danh sách sản phẩm</h3>
                    <ul class="mt-4 space-y-4">
                        ${order.orderDetails.map(detail => `
                            <li class="flex items-center">
                                <img src="${detail.variant.imageUrls[0] || 'https://via.placeholder.com/100'}" alt="product" class="w-20 h-20 object-cover rounded mr-4">
                                <div>
                                    <h4 class="font-semibold">${detail.variant.name}</h4>
                                    <p class="font-semibold">Phân loại: ${detail.variant.variantType}</p>
                                    <p class="font-semibold">Số lượng: ${detail.quantity}</p>
                                    <p class="text-red-500 font-semibold">${formatCurrency(detail.variant.price)}</p>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            })
            .catch(error => {
                console.error(error);
                orderDetails.innerHTML = '<p class="text-center text-red-500">Không thể tải chi tiết đơn hàng.</p>';
            });
    }

    function formatDate(dateString) {
        const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
        return new Date(dateString).toLocaleDateString('vi-VN', options);
    }

    // Format tiền tệ
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }


    function getStatusText(status) {
        const statuses = {
            1: 'Đang xử lý',
            2: 'Đang vận chuyển',
            3: 'Đã giao hàng',
            4: 'Đã hủy',
        };
        return statuses[status] || 'Không xác định';
    }
    function showOrderList() {
        const orderList = document.getElementById('orderListContain');
        const orderDetails = document.getElementById('orderDetails');

        // Hiển thị danh sách đơn hàng và ẩn chi tiết
        orderList.classList.remove('hidden');
        orderDetails.classList.add('hidden');
    }

    fetchOrders();
</script>
</body>
</html>
