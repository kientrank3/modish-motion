<div
  th:fragment="filter"
  id="filterPanel"
  class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
>
  <div
    class="bg-white w-full h-full rounded-none overflow-hidden transform transition-all duration-300 ease-in-out absolute bottom-0 sm:relative sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2"
  >
    <div class="p-6 h-full flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Bộ lọc</h2>
        <button
          onclick="closeFilter()"
          class="text-gray-500 hover:text-gray-700"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="space-y-4 flex-1 overflow-auto">
        <div>
          <h3 class="font-medium mb-2">Màu sắc</h3>
          <div id="colorFilters" class="grid grid-cols-3 gap-2">
            <!-- Filters will be populated here by JavaScript -->
          </div>
        </div>
        <div>
          <h3 class="font-medium mb-2">Kích thước</h3>
          <div id="sizeFilters" class="grid grid-cols-3 gap-2">
            <!-- Filters will be populated here by JavaScript -->
          </div>
        </div>
        <div>
          <h3 class="font-medium mb-2">Giá</h3>
          <div id="priceFilters" class="space-y-2">
            <label class="flex items-center space-x-2">
              <input
                type="radio"
                name="priceRange"
                value="0-350000"
                class="form-radio"
              />
              <span>Dưới 350,000đ</span>
            </label>
            <label class="flex items-center space-x-2">
              <input
                type="radio"
                name="priceRange"
                value="350000-750000"
                class="form-radio"
              />
              <span>350,000đ - 750,000đ</span>
            </label>
            <label class="flex items-center space-x-2">
              <input
                type="radio"
                name="priceRange"
                value="750000"
                class="form-radio"
              />
              <span>Trên 750,000đ</span>
            </label>
          </div>
        </div>
      </div>
      <div class="mt-6 flex gap-4">
        <button
          id="clearFiltersBtn"
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
        >
          Xóa bộ lọc
        </button>
        <button
          id="applyFiltersBtn"
          class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
        >
          Áp dụng
        </button>
      </div>
    </div>
  </div>
</div>

<input type="hidden" id="totalItems" value="[[${totalItems}]]" />
<input type="hidden" id="hasMore" value="[[${hasMore}]]" />
<input type="hidden" id="selectedColors" name="selectedColors" />
<input type="hidden" id="selectedSizes" name="selectedSizes" />

<script th:inline="javascript">
    let selectedColors = [];
    let selectedSizes = [];
    let selectedPriceRange = [];

    // checked (tức là đã kiểm tra rồi)
    function openFilter() {
      document.getElementById("filterPanel").classList.remove("hidden");

    }

    // checked
    function closeFilter() {
      document.getElementById("filterPanel").classList.add("hidden");
    }

    // checked
    function toggleFilter(type, value) {
      // type sẽ là color hoặc size
      const array = type === "color" ? selectedColors : selectedSizes;
      // kiểm tra xem value đã được chọn chưa
      const index = array.indexOf(value);
      if (index === -1) {
        // nếu chưa được chọn thì thêm vào mảng
        array.push(value);
      } else {
        // nếu đã được chọn thì xóa khỏi mảng
        array.splice(index, 1);
      }

      updateFilterUI();
    }

    // // thêm và selectedPriceRange khi click vào radio button
    // function togglePriceFilter(value) {
    //   selectedPriceRange = value;
    // }

    // checked
    function updateFilterUI() {
      document.querySelectorAll(".filter-btn").forEach((btn) => {
        // type sẽ là color hoặc size
        const type = btn.getAttribute("data-type");
        // value sẽ là {id, name, hex} hoặc {id, size}
        const value = btn.getAttribute("data-value");

        // check nếu value đã được chọn thì thực hiện active
        if (
          (type === "color" && selectedColors.includes(value)) ||
          (type === "size" && selectedSizes.includes(value))
        ) {
          btn.classList.add("bg-blue-500");
          // thêm class list là selected
          btn.classList.add("selected");
        } else {
          btn.classList.remove("bg-blue-500");
          // xóa class list là selected
          btn.classList.remove("selected");
        }
      });
    }

    function applyFilters() {
      /*
        Đây là code của productItems: <th:block th:fragment="productItems">
      <div th:each="item : ${items}" class="product-item" th:attr="data-id=${item.id}">
          <div th:replace="components/productItem :: productItem(${item})"></div>
      </div>
      <input type="hidden" id="hasMore" th:value="${hasMore}">
      <input type="hidden" id="totalItems" th:value="${totalItems}">
      <input type="hidden" id="currentPage" th:value="${currentPage}">
      <div th:attr="data-colors=${#strings.listJoin(item.colors, ',')}, data-sizes=${#strings.listJoin(item.sizes, ',')}"></div>
  </th:block>
      */
      const items = /*[[${items}]]*/ [];
      const itemsAfterFilter = [];
        items.forEach((item) => {
          const variants = item.displayVariants;
          variants.forEach((variant) => {
            const sizeID = variant.size.id;
            const size = variant.size.size;
            const colorID = variant.color.id;
            const name = variant.color.color;
            const hex = variant.color.hex;
            const isColorMatched = selectedColors.length === 0 || selectedColors.includes(colorID);
            const isSizeMatched = selectedSizes.length === 0 || selectedSizes.includes(sizeID);

            if (isColorMatched && isSizeMatched) {
          itemsAfterFilter.push(item);
        }
          });
        });



        // const isPriceMatched = selectedPriceRange
        //   ? selectedPriceRange === "0-350000"
        //     ? price < 350000
        //     : selectedPriceRange === "350000-750000"
        //     ? price >= 350000 && price < 750000
        //     : price >= 750000
        //   : true;



        // clear toàn bộ items trong productGrid
        document.getElementById("productGrid").innerHTML = "";
        // thêm lại các items đã lọc vào productGrid
        itemsAfterFilter.forEach((item) => {
          document.getElementById("productGrid").appendChild(item);
        });

        // ẩn filter panel
        closeFilter();

    }

    function clearFilters() {
      updateFilterUI();
    }

    document.addEventListener("DOMContentLoaded", () => {
      document
        .getElementById("applyFiltersBtn")
        .addEventListener("click", applyFilters);
      document
        .getElementById("clearFiltersBtn")
        .addEventListener("click", clearFilters);
    });
</script>
